!function(){"use strict";function e(e,t,n,a){function i(){var e=o();angular.equals(u,e)||window.egApi.saveSettings(JSON.stringify(e),null).done(function(){u=settings})}function o(){return{logo:{url:s.logo.url},xApi:{enabled:s.trackingData.enableXAPI,selectedLrs:s.trackingData.selectedLrs,lrs:{uri:s.trackingData.lrsUrl,authenticationRequired:s.trackingData.authenticationRequired,credentials:{username:s.trackingData.lapLogin,password:s.trackingData.lapPassword}},allowedVerbs:$.map(s.trackingData.statements,function(e,t){return e?t:void 0})},masteryScore:{score:s.masteryScore||0},languages:{selected:s.languages.selectedLanguageCode,customTranslations:s.languages.getCustomTranslations()}}}var s=e,r=location.protocol+"//"+location.host,u=null;s.hasStarterPlan=!0,s.logo=function(){var e={};return e.url="",e.hasLogo=function(){return""!==e.url},e.clear=function(){e.url=""},e.hasError=!1,e.errorText="Unsupported image format",e.errorDescription="(Supported formats: jpg, png, bmp)",e.isLoading=!1,e}(),s.trackingData=function(){var e={};return e.enableXAPI=!0,e.lrsOptions=[{key:"default",text:"easygenerator (recommended)"},{key:"custom",text:"custom LRS"}],e.selectedLrs=e.lrsOptions[0].key,e.lrsOptions.forEach(function(t){t.isSelected=function(){return e.selectedLrs===t.key},t.select=function(){e.lrsOptions.forEach(function(e){e.isSelected(!1)}),t.isSelected(!0),e.selectedLrs=t.key}}),e.customLrsEnabled=function(){return e.enableXAPI&&e.selectedLrs!==e.lrsOptions[0].key},e.lrsUrl="",e.authenticationRequired=!1,e.lapLogin="",e.lapPassword="",e.credentialsEnabled=function(){return e.customLrsEnabled()&&e.authenticationRequired},e.statements={started:!0,stopped:!0,experienced:!0,mastered:!0,answered:!0,passed:!0,failed:!0},e.advancedSettingsExpanded=!1,e.toggleAdvancedSettings=function(){e.advancedSettingsExpanded=!e.advancedSettingsExpanded},e}(),s.masteryScore="",s.languages=function(){function e(){var e=o(r.selectedLanguageCode);return e?e.getResources():[]}function t(){var e=o(r.selectedLanguageCode);return e?e.isEditable:!1}function n(){var e=o(l);return e?e.getNotMappedResources():{}}function i(e,t){e.forEach(function(e){r.languagesList.push(new s(e.code,e.name,!1,e.resources))});var n=new s(l,"Custom",!0);if(t&&t.customTranslations)n.setResources(t.customTranslations);else{var a=o(u),i=a?a.getNotMappedResources():[];n.setResources(i)}r.languagesList.push(n),r.selectedLanguageCode=t&&t.selected?t.selected:u}function o(e){return a("filter")(r.languagesList,{code:e})[0]}function s(e,t,n,a){function i(e){var t=[];return e&&Object.keys(e).forEach(function(n){t.push({key:n,value:e[n]})}),t}function o(e){var t={};return e&&e.forEach(function(e){t[e.key]=e.value}),t}this.code=e,this.name=t,this.isEditable=n,this._resources=[],this.setResources=function(e){this._resources=Array.isArray(e)?e:i(e)},this.getResources=function(){return this._resources},this.getNotMappedResources=function(){return o(this._resources)},a&&this.setResources(a)}var r={},u="en",l="xx";return r.languagesList=[],r.selectedLanguageCode="",r.getSelectedLanguageResources=e,r.isSelectedLanguageEditable=t,r.getCustomTranslations=n,r.init=i,r}(),angular.element(t).on("blur",i);var l={apiUrl:r+"/storage/image/upload",maxFileSize:10,supportedExtensions:["jpeg","jpg","png","bmp","gif"],somethingWentWrongMessage:{title:"Something went wrong",description:"Please, try again"},status:{"default":function(){s.logo.isLoading=!1,s.logo.hasError=!1,s.$apply()},fail:function(e){s.logo.clear(),s.logo.isLoading=!1,s.logo.errorText=e.title,s.logo.errorDescription=e.description,s.logo.hasError=!0,s.$apply()},loading:function(){s.logo.isLoading=!0,s.$apply()}},button:{enable:function(){this.$input.attr("disabled",!1).closest(".image-upload-button").removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0).closest(".image-upload-button").addClass("disabled")},submit:function(){this.$input[0].form.submit(),this.disable(),l.status.loading()},$input:$("#logoInput")},init:function(){l.button.$input.on("change",l.processFile),l.button.enable()},processFile:function(){if(!this.files)return void l.button.submit();if(0!==this.files.length){var e=this.files[0],t=e.name.split(".").pop().toLowerCase();return-1===$.inArray(t,l.supportedExtensions)?void l.status.fail({title:"Unsupported image format",description:"(Allowed formats: "+l.supportedExtensions.join(", ")+")"}):e.size>1024*l.maxFileSize*1024?void l.status.fail({title:"File is too large",description:"(Max file size: "+l.maxFileSize+"MB)"}):void l.uploadFile(e)}},uploadFile:function(e){l.button.disable(),l.status.loading();var t=new FormData;t.append("file",e),$.ajax({url:l.apiUrl,type:"POST",data:t,cache:!1,dataType:"json",processData:!1,contentType:!1}).done(function(e){l.handleResponse(e)}).fail(function(){l.status.fail(l.somethingWentWrongMessage),l.button.enable()})},handleResponse:function(e){try{if(!e)throw"Response is empty";if("object"!=typeof e&&(e=JSON.parse(e)),!e||!e.success||!e.data)throw"Request is not successful";s.logo.url=e.data.url,s.$apply(),l.status.default()}catch(t){l.status.fail(l.somethingWentWrongMessage)}finally{l.button.enable()}}},c=window.egApi;return c.init().then(function(){function e(e){s.hasStarterPlan=e.accessType>0}function t(e){s.trackingData.enableXAPI=e.enabled||!1;var t=e.enabled?"custom":"default";s.trackingData.selectedLrs=e.selectedLrs||t,s.trackingData.lrsUrl=e.lrs.uri||"",s.trackingData.authenticationRequired=e.lrs.authenticationRequired||!1,s.trackingData.lapLogin=e.lrs.credentials.username||"",s.trackingData.lapPassword=e.lrs.credentials.password||"";var n;if(e.allowedVerbs)for(n in s.trackingData.statements)s.trackingData.statements.hasOwnProperty(n)&&(s.trackingData.statements[n]=e.allowedVerbs.indexOf(n)>-1)}function a(e){s.logo.url="",e&&e.url&&(s.logo.url=e.url)}function i(e){s.masteryScore=e&&e.score>=0&&e.score<=100?e.score:100}function r(e){function t(e){return $.ajax({url:e,dataType:"json",contentType:"application/json"})}var a=[];return e.forEach(function(e){a.push(t(e.url).then(function(t){return e.resources=t,e}))}),n.all(a)}var d=c.getManifest(),p=c.getUser(),g=c.getSettings();return e(p),t(g.xApi),a(g.logo),i(g.masteryScore),s.hasStarterPlan&&l.init(),r(d.languages).then(function(e){s.languages.init(e,g.languages),u=o(),s.$applyAsync()})}).fail(function(){c.sendNotificationToEditor("Settings are not initialized.",!1)})}angular.module("settings",[]).controller("SettingsController",["$scope","$window","$q","$filter",e])}(),function(){"use strict";function e(){return{restrict:"A",link:function(e,t){var n=$(t),a="data-tab-link",i="data-tab",o="active",s=n.find("["+a+"]"),r=n.find("["+i+"]");r.hide(),s.first().addClass(o),r.first().show(),s.each(function(e,t){var u=$(t);u.on("click",function(){var e=u.attr(a),t=n.find("["+i+'="'+e+'"]');s.removeClass(o),u.addClass(o),r.hide(),t.show()})})}}}function t(){return{restrict:"A",link:function(e,t){$(t).on("dragstart",function(e){e.preventDefault()})}}}function n(){return{restrict:"A",scope:{spinnerValue:"="},link:function(e,t){$(t).spinner("changed",function(t,n){e.spinnerValue=n,e.$apply()})}}}function a(){return{restrict:"A",scope:{numberValue:"="},link:function(e,t){var n=$(t),a=100;n.on("keydown",function(e){var t=e.charCode||e.keyCode||0;return 8===t||9===t||46===t||t>=37&&40>=t||t>=48&&57>=t||t>=96&&105>=t}),n.on("keyup",function(){e.numberValue>a&&(e.numberValue=a,e.$apply())})}}}function i(){return{restrict:"A",scope:{fadeVisibleValue:"="},link:function(e,t){var n=$(t);n.toggle(e.fadeVisibleValue),e.$watch("fadeVisibleValue",function(e){e?n.fadeIn():n.fadeOut()})}}}function o(){return{restrict:"A",scope:{toggleValue:"="},link:function(e,t){function n(){function e(e){o(e),s(e)}function t(){var e=n();o(!e),u.stop().animate({marginLeft:r(!e)},250)}function n(){return i.hasClass("on")}function a(t){n()!==t&&e(t)}function o(e){i.toggleClass("on",e),i.toggleClass("off",!e)}function s(e){u.css("margin-left",r(e)+"px")}function r(e){return e?0:i.height()-i.width()}var u=$(".switch-toggle-wrapper",i);return{setInitialValue:e,updateValue:a,toggle:t}}function a(e){var t=!1;i.mousedown(function(n){1===n.which&&(t=!0,e())}),i.click(function(){return t?void(t=!1):void e()})}var i=$(t),o=n();o.setInitialValue(e.toggleValue),e.$watch("toggleValue",function(e){o.updateValue(e)}),a(function(){o.toggle(),e.toggleValue=!e.toggleValue,e.$apply()})}}}function s(){return{restrict:"E",scope:{options:"=",value:"=",optionsValue:"=",optionsText:"="},link:function(e,t){var n={dropdown:"dropdown",disabled:"disabled",expanded:"expanded",optionsList:"dropdown-options-list",optionItem:"dropdown-options-item",currentItem:"dropdown-current-item",currentItemText:"dropdown-current-item-text",indicatorHolder:"dropdown-indicator-holder",indicator:"dropdown-indicator"};t.addClass(n.dropdown);var a=$("<div />").addClass(n.currentItem).appendTo(t);$("<div />").addClass(n.currentItemText).appendTo(a);var i=$("<div />").addClass(n.indicatorHolder).appendTo(a);$("<span />").addClass(n.indicator).appendTo(i),$("<ul />").addClass(n.optionsList).appendTo(t),a.on("click",function(e){t.hasClass(n.disabled)||(a.toggleClass(n.expanded),e.stopPropagation())});var o=function(){a.removeClass(n.expanded)};$("html").bind("click",o),$(window).bind("blur",o),e.$watchGroup(["options","value"],function(a){var i=t.find("ul."+n.optionsList),o=t.find("div."+n.currentItemText),s=a[0],r=a[1],u=e.optionsText,l=e.optionsValue;i.empty(),$.each(s,function(t,a){return a[l]==r?void o.text(a[u]):void $("<li />").addClass(n.optionItem).appendTo(i).text(a[u]).on("click",function(){e.value=a[l],e.$apply()})})})}}}angular.module("settings").directive("tabs",e).directive("switchToggle",o).directive("disableDragAndDrop",t).directive("spinner",n).directive("number",a).directive("fadeVisible",i).directive("dropdown",s)}();