!function(){"use strict";function e(e,t){function n(e){return decodeURI((new RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}function a(e){var t=window.parent;t.postMessage(e,window.location.href)}function i(){return{logo:{url:s.logo.url},xApi:{enabled:s.trackingData.enableXAPI,selectedLrs:s.trackingData.selectedLrs,lrs:{uri:s.trackingData.lrsUrl,authenticationRequired:s.trackingData.authenticationRequired,credentials:{username:s.trackingData.lapLogin,password:s.trackingData.lapPassword}},allowedVerbs:$.map(s.trackingData.statements,function(e,t){return e?t:void 0})},masteryScore:{score:s.masteryScore||0}}}var s=e,r=n("courseId"),o=n("templateId"),l=location.protocol+"//"+location.host,c=l+"/api/course/"+r+"/template/"+o,u=1,d=null;s.trackingData=function(){var e={};return e.enableXAPI=!0,e.lrsOptions=[{key:"default",text:"easygenerator (recommended)"},{key:"custom",text:"custom LRS"}],e.selectedLrs=e.lrsOptions[0].key,e.lrsOptions.forEach(function(t){t.isSelected=function(){return e.selectedLrs===t.key},t.select=function(){e.lrsOptions.forEach(function(e){e.isSelected(!1)}),t.isSelected(!0),e.selectedLrs=t.key}}),e.customLrsEnabled=function(){return e.enableXAPI&&e.selectedLrs!==e.lrsOptions[0].key},e.lrsUrl="",e.authenticationRequired=!1,e.lapLogin="",e.lapPassword="",e.credentialsEnabled=function(){return e.customLrsEnabled()&&e.authenticationRequired},e.statements={started:!0,stopped:!0,experienced:!0,mastered:!0,answered:!0,passed:!0,failed:!0},e}(),s.logo=function(){var e={};return e.url="",e.hasLogo=function(){return""!==e.url},e.clear=function(){e.url=""},e.hasError=!1,e.errorText="Unsupported image format",e.errorDescription="(Supported formats: jpg, png, bmp)",e.isLoading=!1,e}(),s.hasStarterPlan=!0,s.masteryScore="",s.advancedSettingsExpanded=!1,s.toggleAdvancedSettings=function(){s.advancedSettingsExpanded=!s.advancedSettingsExpanded},s.saveChanges=function(){var e=i();JSON.stringify(d)!==JSON.stringify(e)&&(a({type:"startSave"}),$.post(c,{settings:JSON.stringify(e)}).done(function(){d=e,a({type:"finishSave",data:{success:!0,message:"All changes are saved"}}),s.$apply()}).fail(function(){a({type:"finishSave",data:{success:!1,message:"Changes have NOT been saved. Please reload the page and change the settings again. Contact support@easygenerator.com if problem persists."}}),s.$apply()}))},angular.element(t).on("blur",s.saveChanges);var p={apiUrl:l+"/storage/image/upload",maxFileSize:10,supportedExtensions:["jpeg","jpg","png","bmp","gif"],somethingWentWrongMessage:{title:"Something went wrong",description:"Please, try again"},status:{"default":function(){s.logo.isLoading=!1,s.logo.hasError=!1,s.$apply()},fail:function(e){s.logo.clear(),s.logo.isLoading=!1,s.logo.errorText=e.title,s.logo.errorDescription=e.description,s.logo.hasError=!0,s.$apply()},loading:function(){s.logo.isLoading=!0,s.$apply()}},button:{enable:function(){this.$input.attr("disabled",!1).closest(".image-upload-button").removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0).closest(".image-upload-button").addClass("disabled")},submit:function(){this.$input[0].form.submit(),this.disable(),p.status.loading()},$input:$("#logoInput")},init:function(){p.button.$input.on("change",p.processFile),p.button.enable()},processFile:function(){if(!this.files)return void p.button.submit();if(0!==this.files.length){var e=this.files[0],t=e.name.split(".").pop().toLowerCase();return-1===$.inArray(t,p.supportedExtensions)?void p.status.fail({title:"Unsupported image format",description:"(Allowed formats: "+p.supportedExtensions.join(", ")+")"}):e.size>1024*p.maxFileSize*1024?void p.status.fail({title:"File is too large",description:"(Max file size: "+p.maxFileSize+"MB)"}):void p.uploadFile(e)}},uploadFile:function(e){p.button.disable(),p.status.loading();var t=new FormData;t.append("file",e),$.ajax({url:p.apiUrl,type:"POST",data:t,cache:!1,dataType:"json",processData:!1,contentType:!1}).done(function(e){p.handleResponse(e)}).fail(function(){p.status.fail(p.somethingWentWrongMessage),p.button.enable()})},handleResponse:function(e){try{if(!e)throw"Response is empty";if("object"!=typeof e&&(e=JSON.parse(e)),!e||!e.success||!e.data)throw"Request is not successful";s.logo.url=e.data.url,s.$apply(),p.status["default"]()}catch(t){p.status.fail(p.somethingWentWrongMessage)}finally{p.button.enable()}}},f=$.ajax({url:l+"/api/identify",type:"POST",contentType:"application/json",dataType:"json",success:function(e){if(e.hasOwnProperty("subscription")&&e.subscription.hasOwnProperty("accessType")){var t=e.subscription.accessType>=u&&new Date(e.subscription.expirationDate)>=new Date;s.hasStarterPlan=t,t&&p.init()}else s.hasStarterPlan=!1;s.$apply()},error:function(){s.hasStarterPlan=!1,s.$apply()}});$.ajax({cache:!1,url:c,dataType:"json",success:function(e){function t(){s.trackingData.enableXAPI=i.xApi.enabled||!1;var e=i.xApi.enabled?"custom":"default";s.trackingData.selectedLrs=i.xApi.selectedLrs||e,s.trackingData.lrsUrl=i.xApi.lrs.uri||"",s.trackingData.authenticationRequired=i.xApi.lrs.authenticationRequired||!1,s.trackingData.lapLogin=i.xApi.lrs.credentials.username||"",s.trackingData.lapPassword=i.xApi.lrs.credentials.password||"";var t;if(i.xApi.allowedVerbs)for(t in s.trackingData.statements)s.trackingData.statements.hasOwnProperty(t)&&(s.trackingData.statements[t]=i.xApi.allowedVerbs.indexOf(t)>-1)}function n(){s.logo.url="",i.logo&&i.logo.url&&(s.logo.url=i.logo.url)}function a(){s.masteryScore="undefined"!=typeof i.masteryScore&&i.masteryScore.score>=0&&i.masteryScore.score<=100?i.masteryScore.score:100}var i,r={xApi:{enabled:!0,selectedLrs:"default",lrs:{credentials:{}}},masteryScore:{}};try{i=JSON.parse(e.settings)||r}catch(o){i=r}t(),n(),a()},error:function(){s.masteryScore=100},complete:function(){f.complete(function(){d=i()}),s.$apply()}})}function t(){return{restrict:"A",link:function(e,t){var n=$(t),a="data-tab-link",i="data-tab",s="active",r=n.find("["+a+"]"),o=n.find("["+i+"]");o.hide(),r.first().addClass(s),o.first().show(),r.each(function(e,t){var l=$(t);l.on("click",function(){var e=l.attr(a),t=n.find("["+i+'="'+e+'"]');r.removeClass(s),l.addClass(s),o.hide(),t.show()})})}}}function n(){return{restrict:"A",link:function(e,t){$(t).on("dragstart",function(e){e.preventDefault()})}}}function a(){return{restrict:"A",scope:{spinnerValue:"="},link:function(e,t){$(t).spinner("changed",function(t,n){e.spinnerValue=n,e.$apply()})}}}function i(){return{restrict:"A",scope:{numberValue:"="},link:function(e,t){var n=$(t),a=100;n.on("keydown",function(e){var t=e.charCode||e.keyCode||0;return 8===t||9===t||46===t||t>=37&&40>=t||t>=48&&57>=t||t>=96&&105>=t}),n.on("keyup",function(){e.numberValue>a&&(e.numberValue=a,e.$apply())})}}}function s(){return{restrict:"A",scope:{fadeVisibleValue:"="},link:function(e,t){var n=$(t);n.toggle(e.fadeVisibleValue),e.$watch("fadeVisibleValue",function(e){e?n.fadeIn():n.fadeOut()})}}}function r(){return{restrict:"A",scope:{toggleValue:"="},link:function(e,t){function n(){function e(e){s(e),r(e)}function t(){var e=n();s(!e),l.stop().animate({marginLeft:o(!e)},250)}function n(){return i.hasClass("on")}function a(t){n()!==t&&e(t)}function s(e){i.toggleClass("on",e),i.toggleClass("off",!e)}function r(e){l.css("margin-left",o(e)+"px")}function o(e){return e?0:i.height()-i.width()}var l=$(".switch-toggle-wrapper",i);return{setInitialValue:e,updateValue:a,toggle:t}}function a(e){var t=!1;i.mousedown(function(n){1===n.which&&(t=!0,e())}),i.click(function(){return t?void(t=!1):void e()})}var i=$(t),s=n();s.setInitialValue(e.toggleValue),e.$watch("toggleValue",function(e){s.updateValue(e)}),a(function(){s.toggle(),e.toggleValue=!e.toggleValue,e.$apply()})}}}angular.module("settings",[]).controller("SettingsController",["$scope","$window",e]).directive("tabs",t).directive("switchToggle",r).directive("disableDragAndDrop",n).directive("spinner",a).directive("number",i).directive("fadeVisible",s)}();