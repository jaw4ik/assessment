!function(){"use strict";function e(e){function t(e){return decodeURI((new RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}var n=e,a=t("courseId"),i=t("templateId"),r=location.protocol+"//"+location.host,o=r+"/api/course/"+a+"/template/"+i,s=1;n.trackingData=function(){var e={};return e.enableXAPI=!0,e.lrsOptions=[{key:"default",text:"easygenerator (recommended)"},{key:"custom",text:"custom LRS"}],e.selectedLrs=e.lrsOptions[0].key,e.lrsOptions.forEach(function(t){t.isSelected=function(){return e.selectedLrs===t.key},t.select=function(){e.lrsOptions.forEach(function(e){e.isSelected(!1)}),t.isSelected(!0),e.selectedLrs=t.key}}),e.customLrsEnabled=function(){return e.enableXAPI&&e.selectedLrs!==e.lrsOptions[0].key},e.lrsUrl="",e.authenticationRequired=!1,e.lapLogin="",e.lapPassword="",e.credentialsEnabled=function(){return e.customLrsEnabled()&&e.authenticationRequired},e.statements={started:!0,stopped:!0,experienced:!0,mastered:!0,answered:!0,passed:!0,failed:!0},e}(),n.logo=function(){var e={};return e.url="",e.hasLogo=function(){return""!==e.url},e.clear=function(){e.url=""},e.hasError=!1,e.errorText="Unsupported image format",e.errorDescription="(Supported formats: jpg, png, bmp)",e.isLoading=!1,e}(),n.hasStarterPlan=!0,n.masteryScore="",n.isSaved=!1,n.isFailed=!1,n.advancedSettingsExpanded=!1,n.toggleAdvancedSettings=function(){n.advancedSettingsExpanded=!n.advancedSettingsExpanded},n.saveChanges=function(){var e={logo:{url:n.logo.url},xApi:{enabled:n.trackingData.enableXAPI,selectedLrs:n.trackingData.selectedLrs,lrs:{uri:n.trackingData.lrsUrl,authenticationRequired:n.trackingData.authenticationRequired,credentials:{username:n.trackingData.lapLogin,password:n.trackingData.lapPassword}},allowedVerbs:$.map(n.trackingData.statements,function(e,t){return e?t:void 0})},masteryScore:{score:n.masteryScore}};n.isFailed=!1,n.isSaved=!1,$.post(o,{settings:JSON.stringify(e)}).done(function(){n.isSaved=!0,n.$apply()}).fail(function(){n.isFailed=!0,n.$apply()})};var l={apiUrl:r+"/storage/image/upload",maxFileSize:10,supportedExtensions:["jpeg","jpg","png","bmp","gif"],somethingWentWrongMessage:{title:"Something went wrong",description:"Please, try again"},status:{"default":function(){n.logo.isLoading=!1,n.logo.hasError=!1,n.$apply()},fail:function(e){n.logo.clear(),n.logo.isLoading=!1,n.logo.errorText=e.title,n.logo.errorDescription=e.description,n.logo.hasError=!0,n.$apply()},loading:function(){n.logo.isLoading=!0,n.$apply()}},button:{enable:function(){this.$input.attr("disabled",!1).closest(".image-upload-button").removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0).closest(".image-upload-button").addClass("disabled")},submit:function(){this.$input[0].form.submit(),this.disable(),l.status.loading()},$input:$("#logoInput")},init:function(){l.button.$input.on("change",l.processFile),l.button.enable()},processFile:function(){if(!this.files)return void l.button.submit();if(0!==this.files.length){var e=this.files[0],t=e.name.split(".").pop().toLowerCase();return-1===$.inArray(t,l.supportedExtensions)?void l.status.fail({title:"Unsupported image format",description:"(Allowed formats: "+l.supportedExtensions.join(", ")+")"}):e.size>1024*l.maxFileSize*1024?void l.status.fail({title:"File is too large",description:"(Max file size: "+l.maxFileSize+"MB)"}):void l.uploadFile(e)}},uploadFile:function(e){l.button.disable(),l.status.loading();var t=new FormData;t.append("file",e),$.ajax({url:l.apiUrl,type:"POST",data:t,cache:!1,dataType:"json",processData:!1,contentType:!1}).done(function(e){l.handleResponse(e)}).fail(function(){l.status.fail(l.somethingWentWrongMessage),l.button.enable()})},handleResponse:function(e){try{if(!e)throw"Response is empty";if("object"!=typeof e&&(e=JSON.parse(e)),!e||!e.success||!e.data)throw"Request is not successful";n.logo.url=e.data.url,n.$apply(),l.status.default()}catch(t){l.status.fail(l.somethingWentWrongMessage)}finally{l.button.enable()}}};$.ajax({cache:!1,url:o,dataType:"json",success:function(e){function t(){n.trackingData.enableXAPI=r.xApi.enabled||!1;var e=r.xApi.enabled?"custom":"default";n.trackingData.selectedLrs=r.xApi.selectedLrs||e,n.trackingData.lrsUrl=r.xApi.lrs.uri||"",n.trackingData.authenticationRequired=r.xApi.lrs.authenticationRequired||!1,n.trackingData.lapLogin=r.xApi.lrs.credentials.username||"",n.trackingData.lapPassword=r.xApi.lrs.credentials.password||"",r.xApi.allowedVerbs&&$.each(n.trackingData.statements,function(e){n.trackingData.statements[e]=$.inArray(e,r.xApi.allowedVerbs)>-1})}function a(){n.logo.url="",r.logo&&r.logo.url&&(n.logo.url=r.logo.url)}function i(){n.masteryScore="undefined"!=typeof r.masteryScore&&r.masteryScore.score>=0&&r.masteryScore.score<=100?r.masteryScore.score:100}var r,o={xApi:{enabled:!0,selectedLrs:"default",lrs:{credentials:{}}},masteryScore:{}};try{r=JSON.parse(e.settings)||o}catch(s){r=o}t(),a(),i(),n.$apply()},error:function(){n.masteryScore=100,n.$apply()}}),$.ajax({url:r+"/api/identify",type:"POST",contentType:"application/json",dataType:"json",success:function(e){if(e.hasOwnProperty("subscription")&&e.subscription.hasOwnProperty("accessType")){var t=e.subscription.accessType>=s&&new Date(e.subscription.expirationDate)>=new Date;n.hasStarterPlan=t,t&&l.init()}else n.hasStarterPlan=!1;n.$apply()},error:function(){n.hasStarterPlan=!1,n.$apply()}})}function t(){return{restrict:"A",link:function(e,t){var n=$(t),a="data-tab-link",i="data-tab",r="active",o=n.find("["+a+"]"),s=n.find("["+i+"]");s.hide(),o.first().addClass(r),s.first().show(),o.each(function(e,t){var l=$(t);l.on("click",function(){var e=l.attr(a),t=n.find("["+i+'="'+e+'"]');o.removeClass(r),l.addClass(r),s.hide(),t.show()})})}}}function n(){return{restrict:"A",link:function(e,t){$(t).on("dragstart",function(e){e.preventDefault()})}}}function a(){return{restrict:"A",scope:{spinnerValue:"="},link:function(e,t){$(t).spinner("changed",function(t,n){e.spinnerValue=n,e.$apply()})}}}function i(){return{restrict:"A",scope:{numberValue:"="},link:function(e,t){var n=$(t),a=100;n.on("keydown",function(e){var t=e.charCode||e.keyCode||0;return 8===t||9===t||46===t||t>=37&&40>=t||t>=48&&57>=t||t>=96&&105>=t}),n.on("keyup",function(){e.numberValue>a&&(e.numberValue=a,e.$apply())})}}}function r(){return{restrict:"A",scope:{fadeVisibleValue:"="},link:function(e,t){var n=$(t);n.toggle(e.fadeVisibleValue),e.$watch("fadeVisibleValue",function(e){e?n.fadeIn():n.fadeOut()})}}}function o(){return{restrict:"A",scope:{toggleValue:"="},link:function(e,t){function n(){function e(e){r(e),o(e)}function t(){var e=n();r(!e),l.stop().animate({marginLeft:s(!e)},250)}function n(){return i.hasClass("on")}function a(t){n()!==t&&e(t)}function r(e){i.toggleClass("on",e),i.toggleClass("off",!e)}function o(e){l.css("margin-left",s(e)+"px")}function s(e){return e?0:i.height()-i.width()}var l=$(".switch-toggle-wrapper",i);return{setInitialValue:e,updateValue:a,toggle:t}}function a(e){var t=!1;i.mousedown(function(n){1===n.which&&(t=!0,e())}),i.click(function(){return t?void(t=!1):void e()})}var i=$(t),r=n();r.setInitialValue(e.toggleValue),e.$watch("toggleValue",function(e){r.updateValue(e)}),a(function(){r.toggle(),e.toggleValue=!e.toggleValue,e.$apply()})}}}angular.module("settings",[]).controller("SettingsController",["$scope",e]).directive("tabs",t).directive("switchToggle",o).directive("disableDragAndDrop",n).directive("spinner",a).directive("number",i).directive("fadeVisible",r)}();