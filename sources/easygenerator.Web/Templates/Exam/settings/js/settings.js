$(function(){function e(e){return decodeURI((RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}var t=e("courseId"),n=e("templateId"),a=location.protocol+"//"+location.host,o=a+"/api/course/"+t+"/template/"+n,i=1,s={trackingData:function(){var e={};return e.enableXAPI=ko.observable(!0),e.lrsOptions=[{key:"default",text:"easygenerator (recommended)"},{key:"custom",text:"custom LRS"}],e.selectedLrs=ko.observable(e.lrsOptions[0].key),ko.utils.arrayMap(e.lrsOptions,function(t){return t.isSelected=ko.computed({read:function(){return e.selectedLrs()==t.key},write:function(){}}),t.select=function(){ko.utils.arrayForEach(e.lrsOptions,function(e){e.isSelected(!1)}),t.isSelected(!0),e.selectedLrs(t.key)},t}),e.customLrsEnabled=ko.computed(function(){return e.enableXAPI()&&e.selectedLrs()!=e.lrsOptions[0].key}),e.lrsUrl=ko.observable(""),e.authenticationRequired=ko.observable(!1),e.lapLogin=ko.observable(),e.lapPassword=ko.observable(),e.credentialsEnabled=ko.computed(function(){return e.customLrsEnabled()&&e.authenticationRequired()}),e.statements={started:ko.observable(!0),stopped:ko.observable(!0),mastered:ko.observable(!0),answered:ko.observable(!0),passed:ko.observable(!0),failed:ko.observable(!0)},e}(),isSaved:ko.observable(!1),isFailed:ko.observable(!1),advancedSettingsExpanded:ko.observable(!1),toggleAdvancedSettings:function(){this.advancedSettingsExpanded(!this.advancedSettingsExpanded())},logo:function(){var e={};return e.url=ko.observable("").extend({throttle:300}),e.hasLogo=ko.computed(function(){return""!==e.url()}),e.clear=function(){e.url("")},e.isError=ko.observable(!1),e.errorText=ko.observable(""),e.errorDescription=ko.observable(""),e.isLoading=ko.observable(!1),e}(),hasStarterPlan:ko.observable(!0),masteryScore:ko.observable("")};s.saveChanges=function(){var e={logo:{url:s.logo.url()},xApi:{enabled:s.trackingData.enableXAPI(),selectedLrs:s.trackingData.selectedLrs(),lrs:{uri:s.trackingData.lrsUrl(),authenticationRequired:s.trackingData.authenticationRequired(),credentials:{username:s.trackingData.lapLogin(),password:s.trackingData.lapPassword()}},allowedVerbs:$.map(s.trackingData.statements,function(e,t){return e()?t:void 0})},masteryScore:{score:s.masteryScore()}};s.isFailed(!1),s.isSaved(!1),$.post(o,{settings:JSON.stringify(e)}).done(function(){s.isSaved(!0)}).fail(function(){s.isFailed(!0)})},ko.bindingHandlers.fadeVisible={init:function(e,t){var n=t();$(e).toggle(ko.unwrap(n))},update:function(e,t){var n=t();ko.unwrap(n)?$(e).fadeIn():$(e).fadeOut()}},ko.bindingHandlers.number={init:function(e){var t=$(e),n=100;t.on("keydown",function(e){var t=e.charCode||e.keyCode||0;return 8==t||9==t||46==t||t>=37&&40>=t||t>=48&&57>=t||t>=96&&105>=t}),t.on("keyup",function(){$(this).val()>n&&$(this).val(n)})}},ko.bindingHandlers.disableDragNDrop={init:function(e){$(e).on("dragstart",function(e){e.preventDefault()})}},ko.bindingHandlers.spinner={init:function(e,t){var n=t();$(e).spinner("changed",function(e,t){n(t)})}},ko.bindingHandlers.switchToggle={init:function(e,t){var n=ko.bindingHandlers.switchToggle,a=n.viewModel(e,t),o=ko.unwrap(t().value());a.setInitialValue(o),n.onClick(e,function(){a.toggle();var e=ko.unwrap(t().value());t().value(!e)})},update:function(e,t){var n=ko.bindingHandlers.switchToggle.viewModel(e,t),a=ko.unwrap(t().value());n.updateValue(a)},viewModel:function(e){function t(e){i(e),s(e)}function n(){var e=a();i(!e),d.stop().animate({marginLeft:r(!e)},250)}function a(){return l.hasClass("on")}function o(e){a()!=e&&t(e)}function i(e){l.toggleClass("on",e),l.toggleClass("off",!e)}function s(e){d.css("margin-left",r(e)+"px")}function r(e){return e?0:l.height()-l.width()}var l=$(e),d=$(".switch-toggle-wrapper",l);return{setInitialValue:t,updateValue:o,toggle:n}},onClick:function(e,t){var n=$(e),a=!1;n.mousedown(function(e){1==e.which&&(a=!0,t())}),n.click(function(){return a?void(a=!1):void t()})}},ko.bindingHandlers.dropdown={cssClasses:{dropdown:"dropdown",disabled:"disabled",expanded:"expanded",optionsList:"dropdown-options-list",optionItem:"dropdown-options-item",currentItem:"dropdown-current-item",currentItemText:"dropdown-current-item-text",indicatorHolder:"dropdown-indicator-holder",indicator:"dropdown-indicator"},init:function(e){var t=$(e),n=ko.bindingHandlers.dropdown.cssClasses;t.addClass(n.dropdown);var a=$("<div />").addClass(n.currentItem).appendTo(t);$("<div />").addClass(n.currentItemText).appendTo(a);var o=$("<div />").addClass(n.indicatorHolder).appendTo(a);$("<span />").addClass(n.indicator).appendTo(o),$("<ul />").addClass(n.optionsList).appendTo(t),a.on("click",function(e){t.hasClass(n.disabled)||(a.toggleClass(n.expanded),e.stopPropagation())});var i=function(){a.removeClass(n.expanded)};$("html").bind("click",i),$(window).bind("blur",i),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){$("html").unbind("click",i),$(window).unbind("blur",i)})},update:function(e,t){var n=$(e),a=ko.bindingHandlers.dropdown.cssClasses,o=n.find("ul."+a.optionsList),i=n.find("div."+a.currentItemText),s=t().options,r=t().optionsText,l=t().value,d=t().optionsValue,c=ko.unwrap(l),u=ko.unwrap(t().disable);u?n.toggleClass(a.disabled):n.removeClass(a.disabled),o.empty(),$.each(s,function(e,t){return t[d]==c?void i.text(t[r]):void $("<li />").addClass(a.optionItem).appendTo(o).text(t[r]).on("click",function(){l(t[d]),n.trigger("change")})})}},ko.bindingHandlers.tabs={init:function(e){var t=$(e),n="data-tab-link",a="data-tab",o="active",i=t.find("["+n+"]"),s=t.find("["+a+"]");s.hide(),i.first().addClass(o),s.first().show(),i.each(function(e,r){var l=$(r);l.on("click",function(){var e=l.attr(n),r=t.find("["+a+'="'+e+'"]');i.removeClass(o),l.addClass(o),s.hide(),r.show()})})}},ko.applyBindings(s,$("#settingsForm")[0]);var r={apiUrl:a+"/storage/image/upload",maxFileSize:10,supportedExtensions:["jpeg","jpg","png","bmp","gif"],somethingWentWrongMessage:{title:"Something went wrong",description:"Please, try again"},status:{"default":function(){s.logo.isLoading(!1),s.logo.isError(!1)},fail:function(e){s.logo.clear(),s.logo.isLoading(!1),s.logo.errorText(e.title),s.logo.errorDescription(e.description),s.logo.isError(!0)},loading:function(){s.logo.isLoading(!0)}},button:{enable:function(){this.$input.attr("disabled",!1).closest(".image-upload-button").removeClass("disabled")},disable:function(){this.$input.attr("disabled",!0).closest(".image-upload-button").addClass("disabled")},submit:function(){this.$input[0].form.submit(),this.disable(),r.status.loading()},$input:$("#logoInput")},init:function(){r.button.$input.on("change",r.processFile),r.button.enable()},processFile:function(){if(!this.files)return void r.button.submit();if(0!==this.files.length){var e=this.files[0],t=e.name.split(".").pop().toLowerCase();return-1===$.inArray(t,r.supportedExtensions)?void r.status.fail({title:"Unsupported image format",description:"(Allowed formats: "+r.supportedExtensions.join(", ")+")"}):e.size>1024*r.maxFileSize*1024?void r.status.fail({title:"File is too large",description:"(Max file size: "+r.maxFileSize+"MB)"}):void r.uploadFile(e)}},uploadFile:function(e){r.button.disable(),r.status.loading();var t=new FormData;t.append("file",e),$.ajax({url:r.apiUrl,type:"POST",data:t,cache:!1,dataType:"json",processData:!1,contentType:!1}).done(function(e){r.handleResponse(e)}).fail(function(){r.status.fail(r.somethingWentWrongMessage),r.button.enable()})},handleResponse:function(e){try{if(!e)throw"Response is empty";if("object"!=typeof e&&(e=JSON.parse(e)),!e||!e.success||!e.data)throw"Request is not success";s.logo.url(e.data.url),r.status.default()}catch(t){r.status.fail(r.somethingWentWrongMessage)}finally{r.button.enable()}}};$.ajax({cache:!1,url:o,dataType:"json",success:function(e){var t,n={logo:{},xApi:{enabled:!0,selectedLrs:"default",lrs:{credentials:{}}},masteryScore:{}};try{t=JSON.parse(e.settings)||n}catch(a){t=n}s.trackingData.enableXAPI(t.xApi.enabled||!1);var o=t.xApi.enabled?"custom":"default";s.trackingData.selectedLrs(t.xApi.selectedLrs||o),s.trackingData.lrsUrl(t.xApi.lrs.uri||""),s.trackingData.authenticationRequired(t.xApi.lrs.authenticationRequired||!1),s.trackingData.lapLogin(t.xApi.lrs.credentials.username||""),s.trackingData.lapPassword(t.xApi.lrs.credentials.password||""),t.xApi.allowedVerbs&&$.each(s.trackingData.statements,function(e,n){n($.inArray(e,t.xApi.allowedVerbs)>-1)}),s.logo.url(t.logo.url||""),s.masteryScore("undefined"!=typeof t.masteryScore&&t.masteryScore.score>=0&&t.masteryScore.score<=100?t.masteryScore.score:100)},error:function(){s.masteryScore(100)}}),$.ajax({url:a+"/api/identify",type:"POST",contentType:"application/json",dataType:"json",success:function(e){if(e.hasOwnProperty("subscription")&&e.subscription.hasOwnProperty("accessType")){var t=e.subscription.accessType>=i&&new Date(e.subscription.expirationDate)>=new Date;s.hasStarterPlan(t),t&&r.init()}else s.hasStarterPlan(!1)},error:function(){s.hasStarterPlan(!1)}})});