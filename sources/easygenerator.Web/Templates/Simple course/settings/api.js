!function(){function e(){var e=$.Deferred(),t=window.parent.localStorageProvider;return t||e.resolve(localStorage["token.settings"]),t.getItem("token.settings").then(function(t){e.resolve(t)}).fail(function(){e.resolve("")}),e.promise()}function t(){return e().then(function(e){m.Authorization+=u("token")||e;var t=$.ajax({url:w,headers:m,cache:!1,type:"POST",contentType:"application/json",dataType:"json"}),n=$.ajax({url:T,headers:m,cache:!1,contentType:"application/json",dataType:"json"}),i=$.ajax({url:j,headers:m,cache:!1,contentType:"application/json",dataType:"json"});return $.when(i,t,n).done(function(e,t,n){y.manifest=s(e[0]),y.user=r(t[0]),y.settings=c(n[0]),y.isInited=!0})})}function n(){if(!y.isInited)throw"Sorry, but you've tried to use api before it was initialized"}function i(){return n(),y.manifest}function a(){return n(),y.user}function o(){return n(),y.settings}function s(e){if(e&&e.languages&&e.languages.length>0)for(var t=0;t<e.languages.length;t++)e.languages[t].url=S+e.languages[t].url;return e}function r(e){e=e.data;var t={accessType:0},n=1;return e.subscription&&e.subscription.accessType&&e.subscription.accessType>=n&&new Date(e.subscription.expirationDate)>=new Date&&(t.accessType=e.subscription.accessType),t}function c(e){var t;return t=e.settings&&e.settings.length>0?JSON.parse(e.settings):{xApi:{enabled:!0,selectedLrs:"default",lrs:{credentials:{}}},masteryScore:{},showConfirmationPopup:!0}}function u(e){var t=RegExp(e+"=(.+?)(&|$)").exec(location.search)||null;return null===t?null:decodeURI(t[1])}function l(e,t,n,i){p();var a={settings:e,extraSettings:t},o={url:T,type:"POST",headers:m,cache:!1,dataType:"json",data:a};return $.ajax(o).done(function(){g(n,!0)}).fail(function(){g(i,!1)}).always(function(){f()})}function p(){h({type:"freeze-editor"})}function f(){h({type:"unfreeze-editor"})}function g(e,t){h({type:"notification",data:{success:t,message:e}})}function d(){h({type:"show-settings"})}function h(e){var t=window.parent;t.postMessage(e,"*")}var y={isInited:!1},v=location.protocol+"//"+location.host,w=v+"/auth/identity",T=v+"/api/course/"+u("courseId")+"/template/"+u("templateId"),S=location.toString().substring(0,location.toString().indexOf("/settings/"))+"/",j=S+"manifest.json",m={Authorization:"Bearer "};window.egApi={init:t,getManifest:i,getUser:a,getSettings:o,saveSettings:l,sendNotificationToEditor:g,showSettings:d}}();